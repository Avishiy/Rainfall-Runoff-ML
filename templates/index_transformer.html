<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainfall-Runoff Prediction</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        body {
            padding: 20px;
        }
        .result-section {
            margin-top: 30px;
        }
        .plot-container {
            margin-bottom: 20px;
        }
        .model-params {
            display: none;
        }
        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        .loading img {
            width: 50px;
            height: 50px;
        }
        .model-selector {
            margin-bottom: 20px;
        }
        .model-btn {
            padding: 15px 20px;
            margin: 0 5px;
            border-radius: 5px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .model-btn.active {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .model-btn i {
            margin-right: 8px;
        }
        /* Model-specific colors */
        .transformer-btn {
            background-color: #6a11cb;
            border-color: #6a11cb;
        }
        .lstm-btn {
            background-color: #2575fc;
            border-color: #2575fc;
        }
        .gru-btn {
            background-color: #8e44ad;
            border-color: #8e44ad;
        }
        .model-card {
            border: 2px solid transparent;
            transition: all 0.3s ease;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .model-card.active {
            border-color: #28a745;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
    </style>
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Rainfall-Runoff Prediction with Deep Learning</h1>
        
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4>Model Training</h4>
            </div>
            <div class="card-body">
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="file">Upload CSV File with Rainfall-Runoff Data:</label>
                        <input type="file" class="form-control-file" id="file" name="file" required>
                    </div>
                    
                    <div class="form-group model-selector">
                        <label class="d-block mb-3">Select Model Architecture:</label>
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="model-card card" id="transformer-card">
                                    <div class="card-body">
                                        <h5 class="card-title">Transformer</h5>
                                        <p class="card-text">Attention-based model suitable for capturing long-range dependencies</p>
                                        <button type="button" class="btn btn-primary model-btn transformer-btn" onclick="selectModel('transformer')">
                                            <i class="fas fa-brain"></i> Transformer
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="model-card card" id="lstm-card">
                                    <div class="card-body">
                                        <h5 class="card-title">LSTM</h5>
                                        <p class="card-text">Long Short-Term Memory neural network for sequential data</p>
                                        <button type="button" class="btn btn-primary model-btn lstm-btn" onclick="selectModel('lstm')">
                                            <i class="fas fa-network-wired"></i> LSTM
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="model-card card" id="gru-card">
                                    <div class="card-body">
                                        <h5 class="card-title">GRU</h5>
                                        <p class="card-text">Gated Recurrent Unit, simpler and faster than LSTM</p>
                                        <button type="button" class="btn btn-primary model-btn gru-btn" onclick="selectModel('gru')">
                                            <i class="fas fa-project-diagram"></i> GRU
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="model_type" name="model_type" value="transformer">
                    </div>
                    
                    <div class="form-group">
                        <label for="window_size">Window Size:</label>
                        <input type="number" class="form-control" id="window_size" name="window_size" value="7" min="1" max="30" required>
                    </div>

                    <!-- Transformer Parameters -->
                    <div id="transformer-params" class="model-params">
                        <h5 class="mt-3">Transformer Parameters:</h5>
                        <div class="form-group">
                            <label for="d_model">Embedding Dimension (d_model):</label>
                            <input type="number" class="form-control" id="d_model" name="d_model" value="64" min="16" required>
                        </div>

                        <div class="form-group">
                            <label for="nhead">Number of Attention Heads:</label>
                            <input type="number" class="form-control" id="nhead" name="nhead" value="4" min="1" required>
                        </div>

                        <div class="form-group">
                            <label for="num_encoder_layers">Number of Encoder Layers:</label>
                            <input type="number" class="form-control" id="num_encoder_layers" name="num_encoder_layers" value="2" min="1" required>
                        </div>

                        <div class="form-group">
                            <label for="dim_feedforward">Feedforward Network Dimension:</label>
                            <input type="number" class="form-control" id="dim_feedforward" name="dim_feedforward" value="128" min="32" required>
                        </div>
                    </div>

                    <!-- RNN Parameters -->
                    <div id="rnn-params" class="model-params">
                        <h5 class="mt-3">RNN Parameters:</h5>
                        <div class="form-group">
                            <label for="hidden_size">Hidden Size:</label>
                            <input type="number" class="form-control" id="hidden_size" name="hidden_size" value="64" min="16" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="num_layers">Number of Layers:</label>
                            <input type="number" class="form-control" id="num_layers" name="num_layers" value="2" min="1" required>
                        </div>
                    </div>

                    <!-- Common Parameters -->
                    <div class="form-group">
                        <label for="dropout">Dropout Rate:</label>
                        <input type="number" class="form-control" id="dropout" name="dropout" value="0.1" min="0" max="0.9" step="0.1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="learning_rate">Learning Rate:</label>
                        <input type="number" class="form-control" id="learning_rate" name="learning_rate" value="0.001" min="0.00001" max="0.1" step="0.0001" required>
                    </div>

                    <div class="form-group">
                        <label for="epochs">Epochs:</label>
                        <input type="number" class="form-control" id="epochs" name="epochs" value="100" min="10" required>
                    </div>

                    <div class="form-group">
                        <label for="optimizer_type">Optimizer:</label>
                        <select class="form-control" id="optimizer_type" name="optimizer_type">
                            <option value="adam">Adam</option>
                            <option value="radam">RAdam</option>
                            <option value="adamw">AdamW</option>
                            <option value="lookahead">Lookahead</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="weight_decay">Weight Decay:</label>
                        <input type="number" class="form-control" id="weight_decay" name="weight_decay" value="0.0001" min="0" max="0.1" step="0.0001" required>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg btn-block">Train Model</button>
                </form>
                
                <div class="loading">
                    <img src="https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif" alt="Loading...">
                    <p>Training model... This may take several minutes. Please wait.</p>
                </div>
            </div>
        </div>
        
        <div id="results" class="result-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4>Training Results</h4>
                </div>
                <div class="card-body">
                    <h5 id="model-title" class="card-title text-center mb-4"></h5>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">Performance Metrics</div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <th>Mean Squared Error (MSE):</th>
                                            <td id="mse-value"></td>
                                        </tr>
                                        <tr>
                                            <th>Mean Absolute Error (MAE):</th>
                                            <td id="mae-value"></td>
                                        </tr>
                                        <tr>
                                            <th>R² Score:</th>
                                            <td id="r2-value"></td>
                                        </tr>
                                        <tr>
                                            <th>Total Predicted Runoff:</th>
                                            <td id="predicted-runoff"></td>
                                        </tr>
                                        <tr>
                                            <th>Total Actual Runoff:</th>
                                            <td id="actual-runoff"></td>
                                        </tr>
                                        <tr>
                                            <th>Difference:</th>
                                            <td id="runoff-difference"></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">Model Parameters</div>
                                <div class="card-body">
                                    <div id="transformer-results" class="model-results">
                                        <table class="table table-sm">
                                            <tr>
                                                <th>Window Size:</th>
                                                <td id="window-size-value"></td>
                                            </tr>
                                            <tr>
                                                <th>Optimizer:</th>
                                                <td id="optimizer-value"></td>
                                            </tr>
                                            <tr>
                                                <th>Learning Rate:</th>
                                                <td id="lr-value"></td>
                                            </tr>
                                            <tr>
                                                <th>Weight Decay:</th>
                                                <td id="wd-value"></td>
                                            </tr>
                                            <tr>
                                                <th>Dropout:</th>
                                                <td id="dropout-value"></td>
                                            </tr>
                                            <tr>
                                                <th>Epochs:</th>
                                                <td id="epochs-value"></td>
                                            </tr>
                                        </table>
                                        <div id="model-specific-params"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="plot-container">
                        <h5>Actual vs Predicted Values</h5>
                        <div class="text-center">
                            <img id="line-plot" class="img-fluid" alt="Line Plot">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="plot-container">
                                <h5>Scatter Plot</h5>
                                <div class="text-center">
                                    <img id="scatter-plot" class="img-fluid" alt="Scatter Plot">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="plot-container">
                                <h5>Bar Plot (First 20 Samples)</h5>
                                <div class="text-center">
                                    <img id="bar-plot" class="img-fluid" alt="Bar Plot">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="plot-container">
                                <h5>Residuals Plot</h5>
                                <div class="text-center">
                                    <img id="residuals-plot" class="img-fluid" alt="Residuals Plot">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="plot-container">
                                <h5>Residuals Distribution</h5>
                                <div class="text-center">
                                    <img id="residuals-distribution" class="img-fluid" alt="Residuals Distribution">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <button id="generate-report-btn" class="btn btn-primary mr-2">Generate Report</button>
                        <button id="clear-session-btn" class="btn btn-danger ml-2">Clear Session</button>
                    </div>
                    
                    <div id="report-section" class="mt-4" style="display: none;">
                        <h4>Generated Report</h4>
                        <div class="text-center">
                            <img id="report-image" class="img-fluid" alt="Generated Report">
                        </div>
                        <div class="text-center mt-3">
                            <a id="download-report" class="btn btn-success" download="transformer_report.png">Download Report</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleModelParams() {
            const modelType = document.getElementById('model_type').value;
            
            if (modelType === 'transformer') {
                document.getElementById('transformer-params').style.display = 'block';
                document.getElementById('rnn-params').style.display = 'none';
            } else { // lstm or gru
                document.getElementById('transformer-params').style.display = 'none';
                document.getElementById('rnn-params').style.display = 'block';
            }
        }
        
        function selectModel(model) {
            document.getElementById('model_type').value = model;
            toggleModelParams();
            
            // Update active button and card
            document.querySelectorAll('.model-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.model-card').forEach(card => card.classList.remove('active'));
            
            document.getElementById(`${model}-card`).classList.add('active');
            document.querySelector(`.${model}-btn`).classList.add('active');
        }
        
        // Initialize model parameters visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            toggleModelParams();
            selectModel('transformer'); // Set default model
        });

        $('#upload-form').on('submit', function(event) {
            event.preventDefault();
            
            $('.loading').show();
            $('#upload-form button').prop('disabled', true);
            $('#results').hide();
            
            const formData = new FormData(this);
            
            $.ajax({
                url: '/upload',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    $('.loading').hide();
                    $('#upload-form button').prop('disabled', false);
                    displayResults(response);
                },
                error: function(xhr) {
                    $('.loading').hide();
                    $('#upload-form button').prop('disabled', false);
                    alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error occurred'));
                }
            });
        });

        function displayResults(data) {
            // Show results section
            $('#results').show();
            
            // Set title
            $('#model-title').text(`${data.model_type} (Window Size: ${data.window_size})`);
            
            // Set metrics
            $('#mse-value').text(data.metrics.mse.toFixed(6));
            $('#mae-value').text(data.metrics.mae.toFixed(6));
            $('#r2-value').text(data.metrics.r2_score.toFixed(6));
            $('#predicted-runoff').text(`${data.metrics.total_predicted_runoff.toFixed(2)} m³/s`);
            $('#actual-runoff').text(`${data.metrics.total_actual_runoff.toFixed(2)} m³/s`);
            $('#runoff-difference').text(`${(data.metrics.total_predicted_runoff - data.metrics.total_actual_runoff).toFixed(2)} m³/s`);
            
            // Set model parameters
            $('#window-size-value').text(data.window_size);
            $('#optimizer-value').text(data.hyperparameters.optimizer.charAt(0).toUpperCase() + data.hyperparameters.optimizer.slice(1));
            $('#lr-value').text(data.hyperparameters.learning_rate);
            $('#wd-value').text(data.hyperparameters.weight_decay);
            $('#dropout-value').text(data.hyperparameters.dropout);
            $('#epochs-value').text(data.hyperparameters.epochs);
            
            // Set model-specific parameters
            let modelType = data.model_type.toLowerCase().split(' ')[0];
            let modelParamsHtml = '<table class="table table-sm mt-3">';
            
            if (modelType === 'transformer') {
                modelParamsHtml += `
                    <tr><th>d_model:</th><td>${data.hyperparameters.d_model}</td></tr>
                    <tr><th>nhead:</th><td>${data.hyperparameters.nhead}</td></tr>
                    <tr><th>num_encoder_layers:</th><td>${data.hyperparameters.num_encoder_layers}</td></tr>
                    <tr><th>dim_feedforward:</th><td>${data.hyperparameters.dim_feedforward}</td></tr>
                `;
            } else {  // LSTM or GRU
                modelParamsHtml += `
                    <tr><th>hidden_size:</th><td>${data.hyperparameters.hidden_size}</td></tr>
                    <tr><th>num_layers:</th><td>${data.hyperparameters.num_layers}</td></tr>
                `;
            }
            
            modelParamsHtml += '</table>';
            $('#model-specific-params').html(modelParamsHtml);
            
            // Set images
            $('#line-plot').attr('src', data.plots.line_plot);
            $('#scatter-plot').attr('src', data.plots.scatter_plot);
            $('#bar-plot').attr('src', data.plots.bar_plot);
            $('#residuals-plot').attr('src', data.plots.residuals_plot);
            $('#residuals-distribution').attr('src', data.plots.residuals_distribution);
            
            // Hide report section
            $('#report-section').hide();
            
            // Scroll to results
            $('html, body').animate({
                scrollTop: $("#results").offset().top
            }, 500);
        }
        
        $('#generate-report-btn').on('click', function() {
            const modelTitle = $('#model-title').text();
            const mse = $('#mse-value').text();
            const mae = $('#mae-value').text();
            const r2 = $('#r2-value').text();
            const predictedRunoff = $('#predicted-runoff').text();
            const actualRunoff = $('#actual-runoff').text();
            
            // Get images
            const linePlot = $('#line-plot').attr('src');
            const scatterPlot = $('#scatter-plot').attr('src');
            const barPlot = $('#bar-plot').attr('src');
            const residualsPlot = $('#residuals-plot').attr('src');
            const residualsDistribution = $('#residuals-distribution').attr('src');
            
            // AJAX call to generate report
            $.ajax({
                url: '/generate_report',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    model_type: modelTitle.split(' (')[0],
                    window_size: $('#window-size-value').text(),
                    hyperparameters: {
                        optimizer: $('#optimizer-value').text(),
                        learning_rate: $('#lr-value').text(),
                        weight_decay: $('#wd-value').text(),
                        dropout: $('#dropout-value').text(),
                        epochs: $('#epochs-value').text(),
                        d_model: $('td:contains("d_model")').next().text(),
                        nhead: $('td:contains("nhead")').next().text(),
                        num_encoder_layers: $('td:contains("num_encoder_layers")').next().text(),
                        dim_feedforward: $('td:contains("dim_feedforward")').next().text(),
                        hidden_size: $('td:contains("hidden_size")').next().text(),
                        num_layers: $('td:contains("num_layers")').next().text()
                    },
                    metrics: {
                        mse: parseFloat(mse),
                        mae: parseFloat(mae),
                        r2_score: parseFloat(r2),
                        total_predicted_runoff: parseFloat(predictedRunoff),
                        total_actual_runoff: parseFloat(actualRunoff)
                    },
                    plots: {
                        line_plot: linePlot,
                        scatter_plot: scatterPlot,
                        bar_plot: barPlot,
                        residuals_plot: residualsPlot,
                        residuals_distribution: residualsDistribution,
                        loss_curve: $('#loss-curve').attr('src') || linePlot // Fallback if loss curve not available
                    }
                }),
                success: function(response) {
                    $('#report-image').attr('src', response.report_url);
                    $('#download-report').attr('href', response.report_url);
                    $('#report-section').show();
                    
                    // Scroll to report
                    $('html, body').animate({
                        scrollTop: $("#report-section").offset().top
                    }, 500);
                },
                error: function(xhr) {
                    alert('Error generating report: ' + xhr.responseJSON.error);
                }
            });
        });
        
        $('#clear-session-btn').on('click', function() {
            $.ajax({
                url: '/clear_session',
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        $('#results').hide();
                        $('#report-section').hide();
                        $('#upload-form')[0].reset();
                        toggleModelParams();
                        
                        // Scroll to top
                        $('html, body').animate({
                            scrollTop: $("body").offset().top
                        }, 500);
                    } else {
                        alert('Error clearing session: ' + response.error);
                    }
                },
                error: function(xhr) {
                    alert('Error clearing session: ' + xhr.responseJSON.error);
                }
            });
        });
    </script>
</body>
</html>